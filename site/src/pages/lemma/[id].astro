---
import Layout from "../../components/Layout.astro";
import data from "../../../public/data.json";

export async function getStaticPaths() {
  // data.lemmata is assumed to be an array of lemma objects
  return data.lemmata.map((lemma) => ({
    params: { id: lemma.lemma_id.toString() },
  }));
}

const id = Number(Astro.params.id);
const lemma = data.lemmata.find(l => l.lemma_id === id);
const meanings = data.meanings.filter(m => m.lemma_id === id);
const meaningsWithQuotes = meanings.map(m => ({
  ...m,
  quotations: data.quotations.filter(q => q.meaning_id === m.meaning_id),
  categories: data.meaningCategories
      .filter(c => c.meaning_id === m.meaning_id)
      .map(c => c.category)
}));
const variants = data.variants.filter(v => v.lemma_id === id);
const quotations = data.quotations.filter(q => q.lemma_id === id);
const external = data.externalLinks.filter(e => e.lemma_id === id);
const crossLinks = data.crossLinks
  .filter(c => c.lemma_id === lemma.lemma_id || c.link === lemma.lemma_id)
  .map(c => {
    const otherId = c.lemma_id === lemma.lemma_id ? c.link : c.lemma_id;
    const target = data.lemmata.find(l => l.lemma_id === otherId);
    return { ...c, target };
  });
---

<Layout title={lemma.original}>
  <h1>{lemma.original}</h1>
  <p>{lemma.translation}</p>

  {lemma.transliteration && <p><strong>Transliteration:</strong> {lemma.transliteration}</p>}
  {lemma.primary_meaning && <p><strong>Primary meaning:</strong> {lemma.primary_meaning}</p>}

  <h2>Meanings</h2>
  {meaningsWithQuotes.map(m => (
  <section>
    <h3>{m.value}</h3>

    {m.categories?.length > 0 && (
    <ul>
      {m.categories.map(cat => <li>{cat}</li>)}
    </ul>
    )}

    <h4>Quotations</h4>
    {m.quotations.length === 0 && <p>No quotations.</p>}
    <ul>
      {m.quotations.map(q => (
      <li>
        <div><strong>Original:</strong> {q.original}</div>
        <div><strong>Translation:</strong> {q.translation}</div>
        <div><strong>Source:</strong> {q.source}</div>
        <div><strong>Line:</strong> {q.line}</div>
        <div><strong>Page:</strong> {q.page}</div>
        <div><strong>Comment:</strong> {q.comment}</div>
      </li>
      ))}
    </ul>
  </section>
  ))}

  <h2>Variants</h2>
  <ul>
    {variants.map(v => <li>{v.original}</li>)}
  </ul>

  <h2>External links</h2>
  <ul>
    {external.map(e => <li><a href={e.url}>{e.display}</a></li>)}
  </ul>

  <h2>Cross-links</h2>
  <ul>
    {crossLinks.map(c => (
    <li>
      <a href={`/lemma/${c.target?.lemma_id}`}>
        {c.target?.original ?? `(unknown lemma ${c.target?.lemma_id})`}
      </a>
    </li>
    ))}
  </ul>
</Layout>
